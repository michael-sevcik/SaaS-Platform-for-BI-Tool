import "reflect-metadata";

import { NVarChar, NVarCharMax, SimpleType, UnknownDataType, DataTypeBase } from "../src/dbModel/dataTypes";
import { EntityMappingConvertor } from "../src/mappingModel/converting/entityMappingConvertor";
import {Type, instanceToPlain, plainToInstance } from "class-transformer";
import {inspect} from "util";
import { Database, Table } from "../src/dbModel/database";

const SERIALIZED_DB_MODEL_EXAMPLE = "{\"name\":\"SaaSPlatform\",\"tables\":[{\"name\":\"CostumerDbModels\",\"schema\":\"DataIntegration\",\"primaryKeys\":[{\"name\":\"CostumerId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"CostumerId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"DbModel\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":false}}],\"description\":null},{\"name\":\"DatabaseConnectionConfigurations\",\"schema\":\"DataIntegration\",\"primaryKeys\":[{\"name\":\"CostumerId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"CostumerId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Provider\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}},{\"name\":\"ConnectionString\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":false}}],\"description\":null},{\"name\":\"AspNetRoleClaims\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}}],\"columns\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}},{\"name\":\"RoleId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"ClaimType\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"ClaimValue\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}}],\"description\":null},{\"name\":\"AspNetRoles\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Name\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":256,\"isNullable\":true}},{\"name\":\"NormalizedName\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":256,\"isNullable\":true}},{\"name\":\"ConcurrencyStamp\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}}],\"description\":null},{\"name\":\"AspNetUserClaims\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}}],\"columns\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}},{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"ClaimType\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"ClaimValue\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}}],\"description\":null},{\"name\":\"AspNetUserLogins\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"LoginProvider\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"ProviderKey\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"LoginProvider\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"ProviderKey\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"ProviderDisplayName\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"description\":null},{\"name\":\"AspNetUserRoles\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"RoleId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"RoleId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"description\":null},{\"name\":\"AspNetUsers\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Name\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":70,\"isNullable\":false}},{\"name\":\"UserName\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":256,\"isNullable\":true}},{\"name\":\"NormalizedUserName\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":256,\"isNullable\":true}},{\"name\":\"Email\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":256,\"isNullable\":true}},{\"name\":\"NormalizedEmail\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":256,\"isNullable\":true}},{\"name\":\"EmailConfirmed\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Boolean\",\"isNullable\":false}},{\"name\":\"PasswordHash\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"SecurityStamp\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"ConcurrencyStamp\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"PhoneNumber\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}},{\"name\":\"PhoneNumberConfirmed\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Boolean\",\"isNullable\":false}},{\"name\":\"TwoFactorEnabled\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Boolean\",\"isNullable\":false}},{\"name\":\"LockoutEnd\",\"dataType\":{\"$type\":\"simple\",\"type\":\"DatetimeOffset\",\"isNullable\":true}},{\"name\":\"LockoutEnabled\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Boolean\",\"isNullable\":false}},{\"name\":\"AccessFailedCount\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}}],\"description\":null},{\"name\":\"AspNetUserTokens\",\"schema\":\"users\",\"primaryKeys\":[{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"LoginProvider\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Name\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}],\"columns\":[{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"LoginProvider\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Name\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Value\",\"dataType\":{\"$type\":\"nVarCharMax\",\"isNullable\":true}}],\"description\":null}]}";
const EXPECTED_RESULT_JSON = "{\"name\":\"SaaSPlatform\",\"tables\":[{\"name\":\"CostumerDbModels\",\"schema\":\"DataIntegration\",\"description\":null,\"columns\":[{\"name\":\"CostumerId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"DbModel\",\"description\":null,\"dataType\":{\"isNullable\":false}}],\"primaryKeys\":[{\"name\":\"CostumerId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]},{\"name\":\"DatabaseConnectionConfigurations\",\"schema\":\"DataIntegration\",\"description\":null,\"columns\":[{\"name\":\"CostumerId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"Provider\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Integer\"}},{\"name\":\"ConnectionString\",\"description\":null,\"dataType\":{\"isNullable\":false}}],\"primaryKeys\":[{\"name\":\"CostumerId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]},{\"name\":\"AspNetRoleClaims\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"Id\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Integer\"}},{\"name\":\"RoleId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"ClaimType\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"ClaimValue\",\"description\":null,\"dataType\":{\"isNullable\":true}}],\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}}]},{\"name\":\"AspNetRoles\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"Id\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"Name\",\"description\":null,\"dataType\":{\"isNullable\":true,\"length\":256}},{\"name\":\"NormalizedName\",\"description\":null,\"dataType\":{\"isNullable\":true,\"length\":256}},{\"name\":\"ConcurrencyStamp\",\"description\":null,\"dataType\":{\"isNullable\":true}}],\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]},{\"name\":\"AspNetUserClaims\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"Id\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Integer\"}},{\"name\":\"UserId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"ClaimType\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"ClaimValue\",\"description\":null,\"dataType\":{\"isNullable\":true}}],\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"simple\",\"type\":\"Integer\",\"isNullable\":false}}]},{\"name\":\"AspNetUserLogins\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"LoginProvider\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"ProviderKey\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"ProviderDisplayName\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"UserId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}}],\"primaryKeys\":[{\"name\":\"LoginProvider\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"ProviderKey\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]},{\"name\":\"AspNetUserRoles\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"UserId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"RoleId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}}],\"primaryKeys\":[{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"RoleId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]},{\"name\":\"AspNetUsers\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"Id\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"Name\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":70}},{\"name\":\"UserName\",\"description\":null,\"dataType\":{\"isNullable\":true,\"length\":256}},{\"name\":\"NormalizedUserName\",\"description\":null,\"dataType\":{\"isNullable\":true,\"length\":256}},{\"name\":\"Email\",\"description\":null,\"dataType\":{\"isNullable\":true,\"length\":256}},{\"name\":\"NormalizedEmail\",\"description\":null,\"dataType\":{\"isNullable\":true,\"length\":256}},{\"name\":\"EmailConfirmed\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Boolean\"}},{\"name\":\"PasswordHash\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"SecurityStamp\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"ConcurrencyStamp\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"PhoneNumber\",\"description\":null,\"dataType\":{\"isNullable\":true}},{\"name\":\"PhoneNumberConfirmed\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Boolean\"}},{\"name\":\"TwoFactorEnabled\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Boolean\"}},{\"name\":\"LockoutEnd\",\"description\":null,\"dataType\":{\"isNullable\":true,\"type\":\"DatetimeOffset\"}},{\"name\":\"LockoutEnabled\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Boolean\"}},{\"name\":\"AccessFailedCount\",\"description\":null,\"dataType\":{\"isNullable\":false,\"type\":\"Integer\"}}],\"primaryKeys\":[{\"name\":\"Id\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]},{\"name\":\"AspNetUserTokens\",\"schema\":\"users\",\"description\":null,\"columns\":[{\"name\":\"UserId\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"LoginProvider\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"Name\",\"description\":null,\"dataType\":{\"isNullable\":false,\"length\":450}},{\"name\":\"Value\",\"description\":null,\"dataType\":{\"isNullable\":true}}],\"primaryKeys\":[{\"name\":\"UserId\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"LoginProvider\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}},{\"name\":\"Name\",\"dataType\":{\"$type\":\"nVarChar\",\"length\":450,\"isNullable\":false}}]}]}";

fdescribe('Db model deserialization', () => {
    it('should deserialize a database model', () => {
        const plain = JSON.parse(SERIALIZED_DB_MODEL_EXAMPLE);
        const result = plainToInstance(Database, plain, {enableImplicitConversion: true,});

        // console.log(inspect(result, { showHidden: false, depth: null, colors: true }));
        // for (const table of result.tables) {
        //     console.log(table.name);
        //     for (const column of table.columns) {
        //         console.log(`\t${column.name}: ${column.dataType.Descriptor}`);
        //     }
        // }

        expect(JSON.stringify(result)).toBe(EXPECTED_RESULT_JSON);
    });
});
